name: "Exporting and deploying the game (Github Releases -> (Windows))"
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev

jobs:
  export_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/workflows/reusable_export.yml
        id: export

      - name: Extract branch name
        shell: bash
        run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >>$GITHUB_OUTPUT
        id: extract_branch

      - name: Selecting bump_version type
        shell: bash
        run: |
          #!/bin/bash

          if [[ "${{ steps.extract_branch.outputs.branch }}" == "main" ]]; then
              echo "bump_version=minor" >> $GITHUB_ENV
          fi

      - name: Creating release with version tag
        id: release
        uses: rymndhng/release-on-push-action@master
        with:
          bump_version_scheme: ${{ env.bump_version }}
          tag_prefix: v
          use_github_release_notes: true

      - name: Upload artifacts to an existing release
        id: artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          files: ${{ steps.export.outputs.archive_directory }}/*

      - name: Sending message to discord
        uses: sarisia/actions-status-discord@v1.12.0
        with:
          nodetail: true
          title: ✅ New build of `${{ steps.extract_branch.outputs.branch }}` is ready ✅!
          description: |
            Version `${{ steps.release.outputs.version }}`
            Click [here](${{ steps.artifacts.outputs.url }}) to download!
          username: GitHub Deploys
          webhook: "${{ secrets.WEBHOOK_RELEASES }}"
          avatar_url: "https://media.licdn.com/dms/image/C4D03AQHoLOeZ2WeGuQ/profile-displayphoto-shrink_800_800/0/1517369560191?e=2147483647&v=beta&t=CytOviQ-TsPLNZQk7kVuUpniYRDLtsDLR3gam4KKGjA"

  # tests_failed:
  #   name: GUT tests have failed
  #   runs-on: ubuntu-latest
  #   needs: export_deploy
  #   if: ${{ failure() }}
  #   steps:
  #       - uses: actions/checkout@v3.5.3
  #       - uses: actions/download-artifact@v2
  #         id: download
  #         with:
  #           name: gut_test_results

  #       - run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >>$GITHUB_OUTPUT
  #         shell: bash
  #         id: extract_branch

  #       - uses: sarisia/actions-status-discord@v1.12.0
  #         with:
  #           content: "<@&${{ secrets.OCACHER_DISCORD_ID }}>"
  #           status: Failure
  #           title: ❌ GUT tests have failed on `Deployment` ❌
  #           description: |
  #             Please, <@&${{ secrets.OCACHER_DISCORD_ID }}>, run the tests locally and fix the issues in order to unblock the branch build.
  #             Click on the `Workflow` field of this message and download the `gut_test_results` artifact in order to download the logs.
  #           username: GitHub CI-CL
  #           webhook: "${{ secrets.WEBHOOK_CI_CL }}"
  #           avatar_url: "https://upload.wikimedia.org/wikipedia/commons/2/27/Pepe_Viyuela.jpg"

    #TODO export_failed
    #TODO Add tests_failed to reusable jobs
    #TODO Make godot version a variable
